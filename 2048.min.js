function newArray(a){return Array.apply(null,new Array(a)).map(function(){return 0})}function checkDone(){done=4==endmove.length,document.getElementById("done").className=done?"visible":"hidden",document.getElementById("board").className=done?"board-off":"board-on"}function init(){done=!1,matrix=newArray(BASE*BASE),cicle=0,points=0,endmove=[],addRandomNum(function(){addRandomNum()}),checkDone()}function buildBoard(){for(var a=document.getElementById("container"),b=0;BASE>b;b++){var c=document.createElement("div");c.className="row";for(var d=0;BASE>d;d++){var e=document.createElement("div");e.className="cell",e.id="c"+(b*BASE+d),c.appendChild(e)}a.appendChild(c)}for(var f=document.getElementById("board"),g=["left","up","right","down"],b=0;4>b;b++){var h=document.createElement("div");h.className="moover moover_"+g[b],h.innerText=".",f.appendChild(h),h.addEventListener("click",handleMooverClick,!1)}init()}function getRandom(a){a=a||10;var b=Math.floor(Math.random()*a+1);return b?b:1}function refreshGrid(a){var b=0;matrix.forEach(function(c,d){var e=c?""+c:"";c>b&&(b=c);var f=document.getElementById("c"+d),g=e?"cell cell"+e:"cell";a==d&&(g+=" new"),f.className=g,f.innerHTML=""+e}),document.getElementById("points").innerHTML=""+points,document.getElementById("maxnum").innerHTML=""+b}function addRandomNum(a){if(!done){cicle++;var b=[];if(matrix.forEach(function(a,c){0>=a&&b.push(c)}),b.length<=0)return!1;var c=2*getRandom(2),d=getRandom(b.length)-1;return matrix[b[d]]=c,refreshGrid(b[d]),a&&a(),!0}}function slide(a){for(var b=Math.sqrt(a.length),c=0;b>c;c++){for(var d=[],e=0,f=0;b>f;f++){var g=a[c*b+f];g>0&&(e==g?(d[d.length-1]+=g,e=0):(d.push(a[c*b+f]),e=g))}for(var f=0;b>f;f++)a[c*b+f]=d.length>f?d[f]:0}}function calcX(a,b,c,d){switch(a){case 1:return d;case 2:return b-c-1;case 3:return b-d-1;default:return c}}function calcY(a,b,c,d){switch(a){case 1:return b-c-1;case 2:return b-d-1;case 3:return c;default:return d}}function rotate(a,b){if(0==b)return a;var c=Math.sqrt(a.length);0>b&&(b=4+b);for(var d=newArray(c),e=0;c>e;e++)for(var f=0;c>f;f++){var g=calcX(b,c,f,e),h=calcY(b,c,f,e);d[e*c+f]=a[h*c+g]}return d}function move(a){points++;var b=matrix.slice(0);b=rotate(b,a),slide(b),b=rotate(b,-a),matrix=b.slice(0),addRandomNum()?endmove=[]:endmove.indexOf(a)<0&&endmove.push(a)}function handleMooverClick(a){var b=0;a.target.className.indexOf("_up")>0?b=3:a.target.className.indexOf("_right")>0?b=2:a.target.className.indexOf("_down")>0&&(b=1),move(b)}function handleKeyDown(a){if(!done){switch(a.keyCode){case 37:move(0);break;case 38:move(3);break;case 39:move(2);break;case 40:move(1)}checkDone()}}var BASE=4,matrix=[],cicle=0,points=0,done=!1,endmove=[];window.addEventListener("load",function(){window.addEventListener("keydown",handleKeyDown,!1),buildBoard()});
