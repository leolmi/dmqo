function newArray(e){return Array.apply(null,new Array(e)).map(function(){return 0})}function checkDone(){done=4==endmove.length,document.getElementById("done").className=done?"visible":"hidden",document.getElementById("board").className=done?"board-off":"board-on"}function init(){done=!1,matrix=newArray(BASE*BASE),cicle=0,points=0,endmove=[],addRandomNum(function(){addRandomNum()}),checkDone()}function buildBoard(){for(var e=document.getElementById("container"),n=0;BASE>n;n++){var r=document.createElement("div");r.className="row";for(var t=0;BASE>t;t++){var a=document.createElement("div");a.className="cell",a.id="c"+(n*BASE+t),r.appendChild(a)}e.appendChild(r)}init()}function getRandom(e){e=e||10;var n=Math.floor(Math.random()*e+1);return n?n:1}function refreshGrid(e){var n=0;matrix.forEach(function(r,t){var a=r?""+r:"";r>n&&(n=r);var o=document.getElementById("c"+t),c=a?"cell cell"+a:"cell";e==t&&(c+=" new"),o.className=c,o.innerHTML=""+a}),document.getElementById("points").innerHTML=""+points,document.getElementById("maxnum").innerHTML=""+n}function addRandomNum(e){if(!done){cicle++;var n=[];if(matrix.forEach(function(e,r){0>=e&&n.push(r)}),n.length<=0)return!1;var r=2*getRandom(2),t=getRandom(n.length)-1;return matrix[n[t]]=r,refreshGrid(n[t]),e&&e(),!0}}function slide(e){for(var n=Math.sqrt(e.length),r=0;n>r;r++){for(var t=[],a=0,o=0;n>o;o++){var c=e[r*n+o];c>0&&(a==c?(t[t.length-1]+=c,a=0):(t.push(e[r*n+o]),a=c))}for(var o=0;n>o;o++)e[r*n+o]=t.length>o?t[o]:0}}function calcX(e,n,r,t){switch(e){case 1:return t;case 2:return n-r-1;case 3:return n-t-1;default:return r}}function calcY(e,n,r,t){switch(e){case 1:return n-r-1;case 2:return n-t-1;case 3:return r;default:return t}}function rotate(e,n){if(0==n)return e;var r=Math.sqrt(e.length);0>n&&(n=4+n);for(var t=newArray(r),a=0;r>a;a++)for(var o=0;r>o;o++){var c=calcX(n,r,o,a),d=calcY(n,r,o,a);t[a*r+o]=e[d*r+c]}return t}function move(e){points++;var n=matrix.slice(0);n=rotate(n,e),slide(n),n=rotate(n,-e),matrix=n.slice(0),addRandomNum()?endmove=[]:endmove.indexOf(e)<0&&endmove.push(e)}function handleKeyDown(e){if(!done){switch(e.keyCode){case 37:move(0);break;case 38:move(3);break;case 39:move(2);break;case 40:move(1)}checkDone()}}var BASE=4,matrix=[],cicle=0,points=0,done=!1,endmove=[];window.addEventListener("keydown",handleKeyDown,!1),buildBoard();
